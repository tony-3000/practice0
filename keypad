#include <lpc213x.h>

#define RS (1 << 8)  // P1.8
#define EN (1 << 9)  // P1.9

void delay(void);
void lcd_cmd(unsigned char cmd);
void lcd_data(unsigned char data);
void lcd_init(void);
char keypad(void);
void lcd_string(const char *str);

int main(void)
{
    PINSEL0 = 0x00000000;  // P0 as GPIO
    PINSEL1 = 0x00000000;  // P0.16â€“P0.31 as GPIO
    PINSEL2 = 0x00000000;  // P1 as GPIO

    IODIR0 = 0x000000FF;   // P0.0 to P0.7 as output (LCD data)
    IODIR1 |= RS | EN | (1 << 19) | (1 << 20) | (1 << 21) | (1 << 22); // RS, EN, rows as output
    IODIR1 &= ~((1 << 16) | (1 << 17) | (1 << 18));  // Columns as input

    lcd_init();

    lcd_string("Keypad Ready");

    while (1)
    {
        char key = keypad();
        lcd_cmd(0x01);        // Clear screen
        lcd_cmd(0x80);        // Move to first line
        lcd_data(key);        // Display key
        delay();
    }
}

void lcd_init(void)
{
    lcd_cmd(0x38);  // 8-bit mode, 2 lines
    lcd_cmd(0x0E);  // Display on, cursor on
    lcd_cmd(0x01);  // Clear display
    lcd_cmd(0x06);  // Entry mode
    lcd_cmd(0x80);  // Set cursor to beginning
}

void lcd_cmd(unsigned char cmd)
{
    IOCLR1 = RS;           // RS = 0 for command
    IOCLR0 = 0xFF;         // Clear data lines
    IOSET0 = cmd;          // Put command
    IOSET1 = EN;           // EN = 1
    delay();
    IOCLR1 = EN;           // EN = 0
}

void lcd_data(unsigned char data)
{
    IOSET1 = RS;           // RS = 1 for data
    IOCLR0 = 0xFF;         // Clear data lines
    IOSET0 = data;         // Put data
    IOSET1 = EN;           // EN = 1
    delay();
    IOCLR1 = EN;           // EN = 0
    IOCLR1 = RS;           // RS = 0
}

void lcd_string(const char *str)
{
    while (*str)
    {
        lcd_data(*str++);
    }
}

char keypad(void)
{
    while (1)
    {
        // ROW 1
        IOCLR1 = (1 << 19);
        IOSET1 = (1 << 20) | (1 << 21) | (1 << 22);
        if (!(IOPIN1 & (1 << 16))) { while (!(IOPIN1 & (1 << 16))); return '1'; }
        if (!(IOPIN1 & (1 << 17))) { while (!(IOPIN1 & (1 << 17))); return '2'; }
        if (!(IOPIN1 & (1 << 18)))
